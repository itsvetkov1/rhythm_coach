---
phase: 01-audio-recording
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ai_rhythm_coach/pubspec.yaml
  - ai_rhythm_coach/lib/services/audio_service.dart
  - ai_rhythm_coach/android/app/build.gradle.kts
autonomous: true

must_haves:
  truths:
    - "AudioService uses record package (not flutter_sound) for microphone capture to WAV/PCM16"
    - "AudioService uses metronome package (not Timer.periodic) for click playback with sample-accurate timing"
    - "Audio session is configured for playAndRecord mode enabling simultaneous recording and playback"
    - "Metronome uses custom click_high.wav and click_low.wav assets with downbeat accent"
    - "Count-in plays 4 beats via metronome before recording begins"
  artifacts:
    - path: "ai_rhythm_coach/pubspec.yaml"
      provides: "Updated dependencies: record, metronome replacing flutter_sound"
      contains: "record:"
    - path: "ai_rhythm_coach/lib/services/audio_service.dart"
      provides: "Rewritten AudioService using record + metronome packages"
      contains: "AudioRecorder"
    - path: "ai_rhythm_coach/android/app/build.gradle.kts"
      provides: "Updated comments removing flutter_sound references"
  key_links:
    - from: "ai_rhythm_coach/lib/services/audio_service.dart"
      to: "record package"
      via: "AudioRecorder for WAV recording"
      pattern: "AudioRecorder"
    - from: "ai_rhythm_coach/lib/services/audio_service.dart"
      to: "metronome package"
      via: "Metronome for click playback"
      pattern: "Metronome"
    - from: "ai_rhythm_coach/lib/services/audio_service.dart"
      to: "audio_session package"
      via: "AudioSession.instance for playAndRecord configuration"
      pattern: "AudioSession\\.instance"
---

<objective>
Replace the broken flutter_sound-based audio pipeline with the record package for WAV recording and the metronome package for accurate click playback. Configure audio_session for simultaneous recording + playback.

Purpose: flutter_sound has documented Android recording corruption issues and Timer.periodic causes metronome drift. This plan replaces both with purpose-built packages that solve these exact problems.
Output: A working AudioService that records to WAV via the record package and plays metronome clicks via the metronome package, with audio session configured for simultaneous operation.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-audio-recording/01-RESEARCH.md
@ai_rhythm_coach/pubspec.yaml
@ai_rhythm_coach/lib/services/audio_service.dart
@ai_rhythm_coach/android/app/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update dependencies in pubspec.yaml and build.gradle.kts</name>
  <files>ai_rhythm_coach/pubspec.yaml, ai_rhythm_coach/android/app/build.gradle.kts</files>
  <action>
In `ai_rhythm_coach/pubspec.yaml`:
1. Remove `flutter_sound: ^9.2.13` from dependencies
2. Remove `device_info_plus: ^11.3.0` from dependencies
3. Add `record: ^6.2.0` under the audio section comment
4. Add `metronome: ^2.0.7` under the audio section comment
5. Update `audio_session: ^0.1.13` to `audio_session: ^0.2.2`
6. Keep all other dependencies unchanged (provider, fftea, http, shared_preferences, path_provider, uuid, permission_handler, cupertino_icons)

In `ai_rhythm_coach/android/app/build.gradle.kts`:
1. Update comment on compileSdk line from "Required by flutter_sound" to "Android SDK 35"
2. Update comment on ndkVersion line from "Required by flutter_sound and other plugins" to "Required by native plugins"
3. Update comment on minSdk line from "Required minimum for flutter_sound and dependencies" to "Required minimum for audio plugins"

After editing both files, run `cd /Users/a1testingmac/rhythm_coach/ai_rhythm_coach && flutter pub get` to install new dependencies and verify no resolution errors.

Do NOT use `flutter_sound` anywhere. Do NOT use `device_info_plus` anywhere. These are the broken packages being replaced.
  </action>
  <verify>
Run `cd /Users/a1testingmac/rhythm_coach/ai_rhythm_coach && flutter pub get` succeeds without errors.
Run `grep -c 'flutter_sound' ai_rhythm_coach/pubspec.yaml` returns 0.
Run `grep -c 'device_info_plus' ai_rhythm_coach/pubspec.yaml` returns 0.
Run `grep 'record:' ai_rhythm_coach/pubspec.yaml` shows the record dependency.
Run `grep 'metronome:' ai_rhythm_coach/pubspec.yaml` shows the metronome dependency.
  </verify>
  <done>pubspec.yaml has record and metronome packages, flutter_sound and device_info_plus removed, audio_session updated to ^0.2.2, flutter pub get succeeds</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite AudioService with record + metronome packages</name>
  <files>ai_rhythm_coach/lib/services/audio_service.dart</files>
  <action>
Completely rewrite `ai_rhythm_coach/lib/services/audio_service.dart`. The new implementation must:

**Imports:**
- `dart:async` (for Completer, StreamSubscription)
- `dart:io` (for File)
- `package:record/record.dart` (AudioRecorder, RecordConfig, AudioEncoder)
- `package:metronome/metronome.dart` (Metronome)
- `package:audio_session/audio_session.dart` (AudioSession, configuration classes)
- `package:path_provider/path_provider.dart` (getApplicationDocumentsDirectory)
- `package:permission_handler/permission_handler.dart` (Permission)
- Do NOT import flutter_sound or device_info_plus

**Keep the AudioRecordingException class** exactly as-is (other code depends on it).

**AudioService class - fields:**
- `AudioRecorder? _recorder`
- `final Metronome _metronome = Metronome()`
- `String? _currentRecordingPath`
- `bool _isInitialized = false`
- `StreamSubscription<int>? _tickSubscription` (for count-in listening)

**initialize() method:**
1. Return early if already initialized
2. Request microphone permission via `Permission.microphone.request()`. Throw `AudioRecordingException` if not granted.
3. Create `_recorder = AudioRecorder()`
4. Initialize metronome: `_metronome.init('assets/audio/click_low.wav', accentedPath: 'assets/audio/click_high.wav', bpm: 120, volume: 100, enableTickCallback: true, timeSignature: 4, sampleRate: 44100)`
5. Call `_configureAudioSession()` (must be AFTER constructing recorder and metronome)
6. Set `_isInitialized = true`

**_configureAudioSession() method:**
- Get `AudioSession.instance`
- Configure with `AudioSessionConfiguration`:
  - `avAudioSessionCategory: AVAudioSessionCategory.playAndRecord`
  - `avAudioSessionCategoryOptions: AVAudioSessionCategoryOptions.allowBluetooth | AVAudioSessionCategoryOptions.defaultToSpeaker`
  - `avAudioSessionMode: AVAudioSessionMode.defaultMode`
  - `androidAudioAttributes: const AndroidAudioAttributes(contentType: AndroidAudioContentType.music, usage: AndroidAudioUsage.media)`
  - `androidAudioFocusGainType: AndroidAudioFocusGainType.gain`

**playCountIn(int bpm) method:**
- Throws if not initialized
- Sets metronome BPM via `_metronome.setBPM(bpm)`
- Creates a `Completer<void>`
- Tracks `int countInBeats = 0`
- Listens to `_metronome.tickStream` -- on each tick, increment countInBeats. When countInBeats reaches 4, complete the completer.
- Calls `_metronome.play()`
- Awaits the completer
- Cancels the tick subscription
- NOTE: metronome keeps playing after count-in completes (recording starts with metronome already running)

**startRecording() method:**
- Throws if not initialized
- Gets app documents directory via `getApplicationDocumentsDirectory()`
- Generates path: `${dir.path}/recording_${DateTime.now().millisecondsSinceEpoch}.wav`
- Creates `RecordConfig(encoder: AudioEncoder.wav, sampleRate: 44100, numChannels: 1, bitRate: 128000, echoCancel: false, noiseSuppress: false, autoGain: false)`
- Calls `await _recorder!.start(config, path: _currentRecordingPath!)`
- IMPORTANT: echoCancel, noiseSuppress, autoGain must all be false -- these distort onset transients needed by RhythmAnalyzer

**stopRecording() method:**
- Throws if not initialized
- Calls `final path = await _recorder!.stop()`
- If path is null or empty, throw `AudioRecordingException('Recording failed - no file path returned')`
- Verify file exists and is non-empty (>100 bytes). If file doesn't exist, throw. If file is very small (<100 bytes), throw with descriptive message.
- Return path

**startMetronome(int bpm) method:**
- `_metronome.setBPM(bpm)`
- `_metronome.play()`
- Note: This is separate from count-in. Used when metronome needs to be started/restarted independently.

**stopMetronome() method:**
- `_metronome.pause()`

**dispose() method:**
- Cancel `_tickSubscription`
- Stop metronome via `_metronome.stop()`
- Dispose recorder via `await _recorder?.dispose()`
- Set `_recorder = null`
- Set `_isInitialized = false`

**Keep these getters/properties with the same signatures** (PracticeController depends on them):
- `bool get isRecording` - use `_recorder?.isRecording ?? false` (record package supports this)
- `bool get isPlaying` - return false for now (not used in Phase 1 flow; playback of recordings will be revisited)

**Remove entirely** (no longer needed):
- `_loadAssetToLocalFile` method (metronome package loads assets directly)
- `playRecording` method (not needed for Phase 1; can be re-added later)
- `stopPlayback` method (not needed for Phase 1; can be re-added later)
- All flutter_sound imports and references
- All device_info_plus imports and references
- `_player`, `_metronomeTimer`, `_beatCount`, `_clickHighPath`, `_clickLowPath` fields

The overall public API surface that PracticeController uses:
- `initialize()` -> Future<void>
- `playCountIn(int bpm)` -> Future<void>
- `startRecording()` -> Future<void>
- `stopRecording()` -> Future<String>
- `startMetronome(int bpm)` -> Future<void> (keep as Future for compatibility even though metronome.play() is sync)
- `stopMetronome()` -> Future<void> (keep as Future for compatibility)
- `dispose()` -> Future<void>
- `isRecording` -> bool getter
  </action>
  <verify>
Run `cd /Users/a1testingmac/rhythm_coach/ai_rhythm_coach && flutter analyze lib/services/audio_service.dart` -- should have no errors (warnings acceptable).
Run `grep -c 'flutter_sound' lib/services/audio_service.dart` returns 0.
Run `grep -c 'device_info_plus' lib/services/audio_service.dart` returns 0.
Run `grep -c 'AudioRecorder' lib/services/audio_service.dart` returns at least 1.
Run `grep -c 'Metronome' lib/services/audio_service.dart` returns at least 1.
Run `grep -c 'AudioSession' lib/services/audio_service.dart` returns at least 1.
Run `grep 'echoCancel: false' lib/services/audio_service.dart` confirms DSP disabled.
  </verify>
  <done>AudioService is rewritten using record package for WAV recording and metronome package for click playback. Audio session configured for playAndRecord. All flutter_sound and device_info_plus references removed. Public API preserved for PracticeController compatibility.</done>
</task>

</tasks>

<verification>
1. `flutter pub get` succeeds in ai_rhythm_coach directory
2. `flutter analyze lib/services/audio_service.dart` has no errors
3. No references to flutter_sound or device_info_plus in audio_service.dart or pubspec.yaml
4. AudioService imports record, metronome, and audio_session packages
5. RecordConfig has echoCancel: false, noiseSuppress: false, autoGain: false
6. Metronome initialized with click_high.wav (accent) and click_low.wav (main), timeSignature: 4
7. playCountIn uses metronome.tickStream with Completer pattern (not Timer.periodic)
8. Audio session configured with playAndRecord category
</verification>

<success_criteria>
- flutter_sound fully removed from project dependencies and code
- record package records to WAV/PCM16 with raw audio (no DSP)
- metronome package plays clicks with sample-accurate timing
- audio_session configures playAndRecord for simultaneous operation
- AudioService public API unchanged (initialize, playCountIn, startRecording, stopRecording, startMetronome, stopMetronome, dispose)
- flutter pub get succeeds and flutter analyze shows no errors in audio_service.dart
</success_criteria>

<output>
After completion, create `.planning/phases/01-audio-recording/01-01-SUMMARY.md`
</output>
