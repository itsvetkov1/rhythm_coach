---
phase: 01-audio-recording
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - ai_rhythm_coach/lib/controllers/practice_controller.dart
  - ai_rhythm_coach/lib/main.dart
  - ai_rhythm_coach/lib/services/audio_service.dart
autonomous: true

must_haves:
  truths:
    - "PracticeController compiles without errors and orchestrates the full practice session using the new AudioService"
    - "main.dart compiles without errors and provides all services via MultiProvider"
    - "After recording stops, the WAV file is validated for RIFF/WAVE headers and non-empty PCM16 data"
    - "The app builds successfully with flutter build apk --debug"
  artifacts:
    - path: "ai_rhythm_coach/lib/controllers/practice_controller.dart"
      provides: "Fixed PracticeController with no duplicate fields, works with new AudioService"
      contains: "PracticeController"
    - path: "ai_rhythm_coach/lib/main.dart"
      provides: "Fixed main.dart with no duplicate provider registrations"
      contains: "MultiProvider"
    - path: "ai_rhythm_coach/lib/services/audio_service.dart"
      provides: "WAV validation method added to AudioService"
      contains: "validateWavFile"
  key_links:
    - from: "ai_rhythm_coach/lib/controllers/practice_controller.dart"
      to: "ai_rhythm_coach/lib/services/audio_service.dart"
      via: "Calls initialize, playCountIn, startRecording, stopRecording, startMetronome, stopMetronome"
      pattern: "_audioService\\."
    - from: "ai_rhythm_coach/lib/controllers/practice_controller.dart"
      to: "ai_rhythm_coach/lib/services/audio_service.dart"
      via: "Calls validateWavFile after stopRecording"
      pattern: "validateWavFile"
    - from: "ai_rhythm_coach/lib/main.dart"
      to: "ai_rhythm_coach/lib/services/audio_service.dart"
      via: "Provider<AudioService> registration"
      pattern: "Provider<AudioService>"
---

<objective>
Fix compilation errors in PracticeController and main.dart (duplicate fields/params), add WAV file validation after recording, and verify the complete app builds successfully.

Purpose: Plan 01 rewrites AudioService but the consuming code (PracticeController, main.dart) has pre-existing bugs (duplicate `_aiCoachingService` field, duplicate provider registration) that prevent compilation. This plan fixes those bugs, adds WAV validation (AUD-04), and verifies the full app builds.
Output: A compilable app where PracticeController uses the new AudioService and validates WAV output after each recording.
</objective>

<execution_context>
@/Users/a1testingmac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/a1testingmac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-audio-recording/01-RESEARCH.md
@.planning/phases/01-audio-recording/01-01-SUMMARY.md
@ai_rhythm_coach/lib/controllers/practice_controller.dart
@ai_rhythm_coach/lib/main.dart
@ai_rhythm_coach/lib/services/audio_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix PracticeController bugs and add WAV validation call</name>
  <files>ai_rhythm_coach/lib/controllers/practice_controller.dart, ai_rhythm_coach/lib/services/audio_service.dart</files>
  <action>
**In `ai_rhythm_coach/lib/controllers/practice_controller.dart`:**

1. **Fix duplicate field bug:** The file has `final AICoachingService _aiCoachingService;` declared TWICE (lines 25-26). Remove the second declaration. There is only one `_aiCoachingService` field.

2. **Fix duplicate code block bug:** Lines 103-108 are a duplicate of lines 97-101 (duplicate `_processSession` call and catch block inside `_finishRecording`). Remove lines 103-108 entirely.

3. **Remove device_info_plus import** if present (it was used in audio_service, not here, but check).

4. **Remove MetronomeBleedException reference** from `_handleError` method (line 213). This exception class does not exist in the new AudioService. Replace that specific `else if` branch with a comment or remove it. Keep AudioRecordingException and AIServiceException handling.

5. **Add WAV validation call in `_finishRecording`:** After `final audioFilePath = await _audioService.stopRecording();` and before `await _processSession(audioFilePath, actualDuration);`, add:
```dart
// Validate the recorded WAV file
await _audioService.validateWavFile(audioFilePath, expectedDurationSec: actualDuration);
```
This ensures the recording is valid before attempting analysis.

**In `ai_rhythm_coach/lib/services/audio_service.dart`:**

Add a `validateWavFile` method to AudioService. This validates the WAV file after recording (AUD-04 requirement).

```dart
/// Validates a WAV file has correct headers and non-empty PCM16 audio data.
/// Throws AudioRecordingException if validation fails.
Future<void> validateWavFile(String filePath, {int? expectedDurationSec}) async {
  final file = File(filePath);

  if (!await file.exists()) {
    throw AudioRecordingException('Recording file not found: $filePath');
  }

  final bytes = await file.readAsBytes();

  // Minimum WAV header is 44 bytes
  if (bytes.length < 44) {
    throw AudioRecordingException(
      'Recording file too small (${bytes.length} bytes) - likely empty or corrupt');
  }

  // Check RIFF header
  final riff = String.fromCharCodes(bytes.sublist(0, 4));
  final wave = String.fromCharCodes(bytes.sublist(8, 12));
  if (riff != 'RIFF' || wave != 'WAVE') {
    throw AudioRecordingException(
      'Invalid WAV file - missing RIFF/WAVE headers');
  }

  // Find and validate data chunk
  int offset = 12;
  bool foundData = false;
  while (offset < bytes.length - 8) {
    final chunkId = String.fromCharCodes(bytes.sublist(offset, offset + 4));
    final chunkSize = bytes[offset + 4] |
        (bytes[offset + 5] << 8) |
        (bytes[offset + 6] << 16) |
        (bytes[offset + 7] << 24);

    if (chunkId == 'data') {
      foundData = true;
      if (chunkSize <= 0) {
        throw AudioRecordingException(
          'WAV file has empty data chunk - no audio was recorded');
      }

      // Check expected size if duration provided
      // WAV at 44100 Hz, 16-bit mono = ~88200 bytes/sec
      if (expectedDurationSec != null) {
        final expectedMinSize = (expectedDurationSec * 44100 * 2 * 0.5).toInt();
        if (chunkSize < expectedMinSize) {
          print('WARNING: Recording shorter than expected '
              '($chunkSize bytes, expected ~${expectedDurationSec * 88200} bytes for ${expectedDurationSec}s)');
        }
      }
      break;
    }

    offset += 8 + chunkSize;
    if (chunkSize % 2 == 1) offset += 1; // WAV chunks are word-aligned
  }

  if (!foundData) {
    throw AudioRecordingException(
      'Invalid WAV file - no data chunk found');
  }
}
```
  </action>
  <verify>
Run `cd /Users/a1testingmac/rhythm_coach/ai_rhythm_coach && flutter analyze lib/controllers/practice_controller.dart` -- should have no errors.
Run `grep -c '_aiCoachingService' lib/controllers/practice_controller.dart` -- should return exactly 3 (1 field declaration, 1 constructor param assignment, 1 usage in _processSession).
Run `grep 'validateWavFile' lib/controllers/practice_controller.dart` -- should show the validation call.
Run `grep 'validateWavFile' lib/services/audio_service.dart` -- should show the method definition.
Run `grep -c 'MetronomeBleedException' lib/controllers/practice_controller.dart` returns 0.
  </verify>
  <done>PracticeController compiles cleanly with no duplicate fields, calls validateWavFile after recording stops, and MetronomeBleedException reference removed. AudioService has validateWavFile method that checks RIFF/WAVE headers and data chunk.</done>
</task>

<task type="auto">
  <name>Task 2: Fix main.dart and verify full app build</name>
  <files>ai_rhythm_coach/lib/main.dart</files>
  <action>
**In `ai_rhythm_coach/lib/main.dart`:**

1. **Fix duplicate provider registration:** Line 58 has `aiCoachingService: context.read<AICoachingService>()` duplicated. Remove the duplicate line (keep only one `aiCoachingService` parameter).

2. **Verify all imports are correct.** The file imports from:
   - `controllers/practice_controller.dart`
   - `services/audio_service.dart`
   - `services/rhythm_analyzer.dart`
   - `services/ai_coaching_service.dart`
   - `services/session_manager.dart`
   - `services/calibration_service.dart`
   - `screens/practice_screen.dart`
   All of these should still be valid after Plan 01 changes.

3. **Verify Provider<AudioService> registration** still works. The `create: (_) => AudioService()` and `dispose: (_, service) => service.dispose()` pattern should still be valid with the rewritten AudioService.

4. **Run full app build** to verify everything compiles together:
```bash
cd /Users/a1testingmac/rhythm_coach/ai_rhythm_coach && flutter build apk --debug
```

If build fails, analyze the error and fix. Common issues:
- Import path changes (shouldn't happen -- we kept file paths the same)
- Type mismatches in AudioService API (shouldn't happen -- we preserved the public API)
- Missing MetronomeBleedException class (fixed in Task 1)

5. **Run flutter analyze on full project:**
```bash
cd /Users/a1testingmac/rhythm_coach/ai_rhythm_coach && flutter analyze
```

Fix any errors (warnings are acceptable for Phase 1).
  </action>
  <verify>
Run `cd /Users/a1testingmac/rhythm_coach/ai_rhythm_coach && flutter analyze` -- no errors (warnings acceptable).
Run `cd /Users/a1testingmac/rhythm_coach/ai_rhythm_coach && flutter build apk --debug` -- build succeeds.
Run `grep -c 'aiCoachingService' lib/main.dart` -- should return exactly 1 (single provider param, not duplicated).
  </verify>
  <done>main.dart compiles cleanly with no duplicate parameters. Full app builds successfully with flutter build apk --debug. flutter analyze shows no errors across the entire project.</done>
</task>

</tasks>

<verification>
1. `flutter analyze` across the full project produces no errors
2. `flutter build apk --debug` succeeds
3. No duplicate field declarations in practice_controller.dart
4. No duplicate provider registrations in main.dart
5. validateWavFile method exists in AudioService and is called from PracticeController._finishRecording
6. No references to MetronomeBleedException in any file
7. No references to flutter_sound or device_info_plus in any modified file
</verification>

<success_criteria>
- PracticeController has exactly one _aiCoachingService field and no duplicate code blocks
- main.dart has exactly one aiCoachingService parameter in PracticeController constructor
- WAV validation runs after every recording: checks RIFF/WAVE headers and data chunk
- `flutter build apk --debug` completes successfully
- `flutter analyze` shows no errors across the full project
</success_criteria>

<output>
After completion, create `.planning/phases/01-audio-recording/01-02-SUMMARY.md`
</output>
